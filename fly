local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Players = game:GetService("Players")

local player = Players.LocalPlayer
local character, humanoidRootPart
local flying = false
local bodyVelocity
local speed = 50

-- Setup khi spawn nhân vật
local function setupCharacter(char)
	character = char
	humanoidRootPart = character:WaitForChild("HumanoidRootPart")
end

setupCharacter(player.Character or player.CharacterAdded:Wait())
player.CharacterAdded:Connect(setupCharacter)

-- Toggle + chỉnh tốc độ
UserInputService.InputBegan:Connect(function(input, gameProcessed)
	if gameProcessed then return end

	-- Toggle bay
	if input.KeyCode == Enum.KeyCode.F then
		flying = not flying
		if flying then
			bodyVelocity = Instance.new("BodyVelocity")
			bodyVelocity.MaxForce = Vector3.new(1e6, 1e6, 1e6) -- mạnh hơn để giữ bay mượt
			bodyVelocity.P = 1e5
			bodyVelocity.Velocity = Vector3.zero
			bodyVelocity.Parent = humanoidRootPart
			print("Flying ON")
		else
			if bodyVelocity then
				bodyVelocity:Destroy()
				bodyVelocity = nil
			end
			print("Flying OFF")
		end
	end

	-- Tăng/giảm tốc độ
	if flying then
		if input.KeyCode == Enum.KeyCode.One then
			speed = math.max(10, speed - 10)
			print("Speed:", speed)
		elseif input.KeyCode == Enum.KeyCode.Two then
			speed = speed + 10
			print("Speed:", speed)
		end
	end
end)

-- Điều khiển bay
RunService.Heartbeat:Connect(function()
	if flying and bodyVelocity and humanoidRootPart then
		-- Lấy hướng input WASD + Space + Shift
		local forward = (UserInputService:IsKeyDown(Enum.KeyCode.W) and 1 or 0) - (UserInputService:IsKeyDown(Enum.KeyCode.S) and 1 or 0)
		local right   = (UserInputService:IsKeyDown(Enum.KeyCode.D) and 1 or 0) - (UserInputService:IsKeyDown(Enum.KeyCode.A) and 1 or 0)
		local up      = (UserInputService:IsKeyDown(Enum.KeyCode.Space) and 1 or 0) - (UserInputService:IsKeyDown(Enum.KeyCode.LeftShift) and 1 or 0)

		-- Camera hướng
		local camCF = workspace.CurrentCamera.CFrame
		local moveDir = (camCF.LookVector * forward) + (camCF.RightVector * right) + (Vector3.new(0,1,0) * up)

		if moveDir.Magnitude > 0 then
			bodyVelocity.Velocity = moveDir.Unit * speed
		else
			bodyVelocity.Velocity = Vector3.zero
		end
	end
end)
